# 第 12 题：$nextTick 实现方式

### 介绍

nextTick() 是 Vue 3 中的一个核心函数，它的作用是延迟执行某些操作，直到下一次 DOM 更新循环结束之后再执行。这个函数常用于在 Vue 更新 DOM 后立即获取更新后的 DOM 状态，或者在组件渲染完成后执行某些操作。

### $nextTick 存在的原因

在 Vue 中，当你修改了数据后，Vue 并不会立即更新 DOM，而是将这些更新操作放入一个队列中，等待下一次事件循环时统一处理。这种机制被称为"异步更新队列"。这种做法带来的好处就是可以将多次数据更新合并成一次，减少操作DOM的次数，如果不采用这种方法，假设数据改变100次就要去更新100次DOM，而频繁的DOM更新是很耗性能的。

因此你在修改数据后立即尝试访问 DOM，可能会发现 DOM 还没有更新，从而导致获取的数据是旧的。nextTick() 就是为了解决这个问题而存在的，它确保你的操作在 DOM 更新完成后执行。

### 作用

nextTick 接收一个回调函数作为参数，并将这个回调函数延迟到DOM更新后才执行；

以下是一些常见的使用场景：

  * 在修改数据后立即获取更新后的 DOM 状态。
  * 在组件渲染完成后执行某些操作，例如初始化第三方库。
  * 在子组件更新后，父组件需要根据子组件的状态进行某些操作。

### 实现原理

nextTick() 的实现依赖于 JavaScript 的事件循环机制。
将传入的回调函数包装成异步任务，异步任务又分微任务和宏任务，为了尽快执行所以优先选择微任务。
nextTick 提供了四种异步方法 Promise.then、MutationObserver、setImmediate、setTimeout(fn,0)。

### 源码解读

Vue 在更新 DOM 时是异步执行的。只要侦听到数据变化，Vue 将开启一个队列，并缓冲在同一事件循环中发生的所有数据变更。如果同一个 watcher 被多次触发，只会被推入到队列中一次。这种在缓冲时去除重复数据对于避免不必要的计算和 DOM 操作是非常重要的。然后，在下一个的事件循环“tick”中，Vue 刷新队列并执行实际 (已去重的) 工作。Vue 在内部对异步队列尝试使用原生的 Promise.then、MutationObserver 和 setImmediate，如果执行环境不支持，则会采用 setTimeout(fn, 0) 代替。

[参考链接](https://zhuanlan.zhihu.com/p/174396758)
[参考链接](https://www.runoob.com/vue3/vue3-api-nexttick.html)

